<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–í–æ–ª—à–µ–±–Ω—ã–π –•–æ–ª—Å—Ç | –£—á–∏—Å—å —Ä–∏—Å–æ–≤–∞—Ç—å –±—É–∫–≤—ã!</title>
  <style>
    :root {
      --primary: #6a5acd;
      --success: #4caf50;
      --warning: #ff9800;
      --canvas-bg: #f8f9ff;
      --point: #ff5252;
      --point-active: #ff1744;
      --line-complete: #43a047;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Comic Sans MS', cursive, sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #bbdefb);
      color: #212121;
      line-height: 1.5;
      padding: 15px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 20px;
    }

    .canvas-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      padding: 20px;
      text-align: center;
    }

    canvas {
      background-color: var(--canvas-bg);
      border: 4px dashed var(--primary);
      border-radius: 16px;
      cursor: crosshair;
      max-width: 100%;
      height: auto;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .panel {
      background: white;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }

    h1 {
      color: var(--primary);
      margin-bottom: 10px;
      font-size: 2.2rem;
      text-shadow: 2px 2px 0 #ffd54f;
    }

    .subtitle {
      color: #546e7a;
      margin-bottom: 25px;
      font-size: 1.3rem;
    }

    .mode-btn {
      display: block;
      width: 100%;
      padding: 16px;
      margin: 8px 0;
      border: none;
      border-radius: 16px;
      font-size: 1.3rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 0 rgba(0,0,0,0.1);
    }

    .mode-btn:hover { transform: translateY(-2px); }
    .mode-btn:active { transform: translateY(2px); }

    .learn-mode { background: linear-gradient(to right, #81c784, #43a047); color: white; }
    .create-mode { background: linear-gradient(to right, #ffb74d, #ffa726); color: white; }
    .apply-btn { background: linear-gradient(to right, #64b5f6, #1976d2); color: white; }

    .letters-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .letter-btn {
      aspect-ratio: 1;
      border-radius: 12px;
      background: #e3f2fd;
      border: 3px solid var(--primary);
      font-size: 1.8rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .letter-btn:hover {
      background: #bbdefb;
      transform: scale(1.05);
    }

    .letter-btn.active {
      background: #4fc3f7;
      border-color: #0288d1;
      box-shadow: 0 0 15px rgba(2, 136, 209, 0.5);
    }

    .status {
      margin-top: 15px;
      padding: 12px;
      border-radius: 16px;
      font-weight: bold;
      min-height: 28px;
      background: #e8f5e9;
      color: #2e7d32;
    }

    .instructions {
      background: #e3f2fd;
      border-left: 4px solid var(--primary);
      padding: 12px;
      border-radius: 0 12px 12px 0;
      margin-top: 10px;
      font-size: 0.95rem;
    }

    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr; }
      .letters-grid { grid-template-columns: repeat(6, 1fr); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="canvas-container">
      <h1>‚ú® –í–æ–ª—à–µ–±–Ω—ã–π –•–æ–ª—Å—Ç ‚ú®</h1>
      <div class="subtitle">–°–æ–µ–¥–∏–Ω—è–π —Ç–æ—á–∫–∏ –∏ —É—á–∏—Å—å —Ä–∏—Å–æ–≤–∞—Ç—å –±—É–∫–≤—ã!</div>
      <canvas id="drawingCanvas" width="600" height="500"></canvas>
      <div id="status" class="status">–í—ã–±–µ—Ä–∏ –±—É–∫–≤—É –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!</div>
    </div>

    <div class="sidebar">
      <div class="panel">
        <h2>üé® –†–µ–∂–∏–º—ã</h2>
        <button class="mode-btn learn-mode" data-mode="learn">–£—á–∏—Ç—å—Å—è —Ä–∏—Å–æ–≤–∞—Ç—å</button>
        <button class="mode-btn create-mode" data-mode="create">–°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é —Ñ–∏–≥—É—Ä—É</button>
        <div class="instructions">
          <strong>üí° –°–æ–≤–µ—Ç:</strong> –í —Ä–µ–∂–∏–º–µ ¬´–°–æ–∑–¥–∞—Ç—å¬ª –Ω–∞—Ä–∏—Å—É–π —Ñ–∏–≥—É—Ä—É –∏ –Ω–∞–∂–º–∏ ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å¬ª, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∫–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12)!
        </div>
      </div>

      <div class="panel">
        <h2>üî§ –í—ã–±–µ—Ä–∏ –±—É–∫–≤—É</h2>
        <div class="letters-grid" id="lettersGrid">
          <!-- –ö–Ω–æ–ø–∫–∏ –±—É–∫–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
        </div>
      </div>

      <div class="panel" id="createPanel" style="display:none;">
        <h2>‚úèÔ∏è –¢–≤–æ—è —Ñ–∏–≥—É—Ä–∞</h2>
        <button class="mode-btn apply-btn" id="applyBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥</button>
        <div class="instructions">
          –ù–∞—Ä–∏—Å—É–π —Ñ–∏–≥—É—Ä—É –ø–∞–ª—å—Ü–µ–º –∏–ª–∏ –º—ã—à–∫–æ–π. –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —à—Ç—Ä–∏—Ö–æ–≤!
        </div>
      </div>
    </div>
  </div>

  <script>
    // ======================
    // 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ======================
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('status');
    const lettersGrid = document.getElementById('lettersGrid');
    const createPanel = document.getElementById('createPanel');
    const applyBtn = document.getElementById('applyBtn');

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    const POINT_RADIUS = 8;
    const ACTIVE_POINT_RADIUS = 12;
    const LINE_WIDTH = 3;
    const CANVAS_SCALE = window.devicePixelRatio || 1;

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    const state = {
      mode: 'learn', // 'learn' | 'create'
      currentLetter: null,
      currentStep: 0,
      isDrawing: false,
      startX: 0,
      startY: 0,
      strokes: [], // –î–ª—è —Ä–µ–∂–∏–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è: –º–∞—Å—Å–∏–≤ —à—Ç—Ä–∏—Ö–æ–≤ [[{x,y},...], ...]
      currentStroke: [], // –¢–µ–∫—É—â–∏–π —à—Ç—Ä–∏—Ö –≤ —Ä–µ–∂–∏–º–µ —Å–æ–∑–¥–∞–Ω–∏—è
      lettersData: {} // –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    };

    // ======================
    // 2. –î–ê–ù–ù–´–ï –ë–£–ö–í (–º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –ø—Ä–∏–º–µ—Ä)
    // ======================
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ JSON –∏–ª–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å
    const SAMPLE_LETTERS = {
      '–ê': { points: [[[150, 400], [300, 100]], [[300, 100], [450, 400]], [[200, 250], [400, 250]]] },
      '–ë': { points: [[[150, 150], [250, 150], [250, 300], [150, 300]], [[150, 300], [150, 450], [250, 450]]] },
      '–í': { points: [[[150, 150], [250, 150], [250, 300], [150, 300], [150, 150]], [[150, 300], [250, 300], [250, 450], [150, 450]]] },
      '–ì': { points: [[[150, 150], [300, 150], [300, 450]]] },
      '–î': { points: [[[150, 450], [300, 150], [450, 450]], [[300, 150], [300, 300]]] },
      '–ï': { points: [[[400, 150], [150, 150], [150, 450], [400, 450]], [[150, 300], [300, 300]]] },
      "T": { points: [
    [
      [
        0.1883116883116883,
        0.20739462209302326
      ],
      [
        0.18993506493506493,
        0.20739462209302326
      ],
      [
        0.19155844155844157,
        0.20739462209302326
      ],
      [
        0.19480519480519481,
        0.20933260658914726
      ],
      [
        0.20454545454545453,
        0.2112705910852713
      ],
      [
        0.2159090909090909,
        0.21320857558139533
      ],
      [
        0.2418831168831169,
        0.21320857558139533
      ],
      [
        0.2711038961038961,
        0.21320857558139533
      ],
      [
        0.3051948051948052,
        0.21320857558139533
      ],
      [
        0.3538961038961039,
        0.21320857558139533
      ],
      [
        0.40259740259740256,
        0.21320857558139533
      ],
      [
        0.45129870129870125,
        0.21320857558139533
      ],
      [
        0.5016233766233766,
        0.21320857558139533
      ],
      [
        0.5503246753246753,
        0.2151465600775194
      ],
      [
        0.6022727272727273,
        0.2151465600775194
      ],
      [
        0.6444805194805195,
        0.2151465600775194
      ],
      [
        0.6785714285714285,
        0.2151465600775194
      ],
      [
        0.7094155844155844,
        0.2151465600775194
      ],
      [
        0.7337662337662337,
        0.2151465600775194
      ],
      [
        0.7516233766233766,
        0.21320857558139533
      ],
      [
        0.7678571428571428,
        0.2112705910852713
      ],
      [
        0.7808441558441558,
        0.2112705910852713
      ],
      [
        0.7922077922077922,
        0.20933260658914726
      ],
      [
        0.801948051948052,
        0.20739462209302326
      ],
      [
        0.8051948051948051,
        0.20739462209302326
      ],
      [
        0.8068181818181819,
        0.20739462209302326
      ],
      [
        0.8051948051948051,
        0.20739462209302326
      ],
      [
        0.8035714285714285,
        0.20739462209302326
      ],
      [
        0.801948051948052,
        0.20739462209302326
      ],
      [
        0.8003246753246753,
        0.20739462209302326
      ]
    ],
    [
      [
        0.4772727272727273,
        0.2228984980620155
      ],
      [
        0.4772727272727273,
        0.2248364825581395
      ],
      [
        0.4772727272727273,
        0.22871245155038758
      ],
      [
        0.4772727272727273,
        0.23258842054263565
      ],
      [
        0.4772727272727273,
        0.23646438953488372
      ],
      [
        0.4772727272727273,
        0.24421632751937983
      ],
      [
        0.4772727272727273,
        0.25778221899224807
      ],
      [
        0.4805194805194805,
        0.2713481104651163
      ],
      [
        0.4821428571428572,
        0.2849140019379845
      ],
      [
        0.4837662337662338,
        0.30429384689922484
      ],
      [
        0.48538961038961037,
        0.31979772286821706
      ],
      [
        0.48538961038961037,
        0.3372395833333333
      ],
      [
        0.48538961038961037,
        0.35274345930232553
      ],
      [
        0.48538961038961037,
        0.37018531976744184
      ],
      [
        0.48538961038961037,
        0.38375121124031003
      ],
      [
        0.48538961038961037,
        0.40119307170542634
      ],
      [
        0.48538961038961037,
        0.41669694767441856
      ],
      [
        0.4886363636363636,
        0.439952761627907
      ],
      [
        0.4886363636363636,
        0.46514656007751937
      ],
      [
        0.4902597402597403,
        0.4864643895348837
      ],
      [
        0.4902597402597403,
        0.501968265503876
      ],
      [
        0.4902597402597403,
        0.5194101259689922
      ],
      [
        0.4902597402597403,
        0.5329760174418604
      ],
      [
        0.4902597402597403,
        0.5484798934108527
      ],
      [
        0.4902597402597403,
        0.563983769379845
      ],
      [
        0.4902597402597403,
        0.5794876453488371
      ],
      [
        0.4902597402597403,
        0.5969295058139534
      ],
      [
        0.4886363636363636,
        0.6124333817829457
      ],
      [
        0.4886363636363636,
        0.627937257751938
      ],
      [
        0.4886363636363636,
        0.6395651647286821
      ],
      [
        0.4886363636363636,
        0.6511930717054263
      ],
      [
        0.4886363636363636,
        0.6589450096899224
      ],
      [
        0.4886363636363636,
        0.6666969476744187
      ],
      [
        0.487012987012987,
        0.6802628391472868
      ],
      [
        0.487012987012987,
        0.693828730620155
      ],
      [
        0.487012987012987,
        0.7054566375968991
      ],
      [
        0.487012987012987,
        0.7170845445736433
      ],
      [
        0.487012987012987,
        0.7228984980620156
      ],
      [
        0.487012987012987,
        0.7306504360465117
      ],
      [
        0.48538961038961037,
        0.7384023740310077
      ],
      [
        0.48538961038961037,
        0.7422783430232558
      ],
      [
        0.48538961038961037,
        0.7461543120155039
      ],
      [
        0.48538961038961037,
        0.7500302810077519
      ],
      [
        0.48538961038961037,
        0.75390625
      ],
      [
        0.48538961038961037,
        0.755844234496124
      ],
      [
        0.48538961038961037,
        0.7577822189922481
      ],
      [
        0.4821428571428572,
        0.7635961724806201
      ],
      [
        0.4821428571428572,
        0.7694101259689922
      ],
      [
        0.4821428571428572,
        0.7732860949612402
      ],
      [
        0.4821428571428572,
        0.7771620639534883
      ],
      [
        0.4821428571428572,
        0.7810380329457364
      ],
      [
        0.4805194805194805,
        0.7849140019379844
      ],
      [
        0.4805194805194805,
        0.7868519864341086
      ],
      [
        0.4805194805194805,
        0.7887899709302326
      ],
      [
        0.4805194805194805,
        0.7907279554263567
      ]
    ]
  ]
}
    };

    // ======================
    // 3. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
    // ======================
    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // –§–æ–Ω —Å –ª–µ–≥–∫–∏–º —É–∑–æ—Ä–æ–º –¥–ª—è –¥–µ—Ç–µ–π
      ctx.fillStyle = '#f8f9ff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawPoint(x, y, isActive = false) {
      ctx.beginPath();
      ctx.arc(x, y, isActive ? ACTIVE_POINT_RADIUS : POINT_RADIUS, 0, Math.PI * 2);
      ctx.fillStyle = isActive ? '#ff1744' : '#ff5252';
      ctx.fill();
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 2;
      ctx.stroke();

      // –≠—Ñ—Ñ–µ–∫—Ç "—Å–∏—è–Ω–∏—è" –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—á–∫–∏
      if (isActive) {
        const gradient = ctx.createRadialGradient(x, y, 5, x, y, 20);
        gradient.addColorStop(0, 'rgba(255, 23, 68, 0.6)');
        gradient.addColorStop(1, 'rgba(255, 23, 68, 0)');
        ctx.beginPath();
        ctx.arc(x, y, 20, 0, Math.PI * 2);
        ctx.fillStyle = gradient;
        ctx.fill();
      }
    }

    function drawLine(start, end, isComplete = false) {
      ctx.beginPath();
      ctx.moveTo(start[0], start[1]);
      ctx.lineTo(end[0], end[1]);
      ctx.strokeStyle = isComplete ? '#43a047' : '#6a5acd';
      ctx.lineWidth = isComplete ? 4 : 2;
      ctx.lineCap = 'round';
      ctx.stroke();

      // –°—Ç—Ä–µ–ª–∫–∞ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –≤ –æ–±—É—á–µ–Ω–∏–∏)
      if (!isComplete && state.mode === 'learn') {
        const angle = Math.atan2(end[1] - start[1], end[0] - start[0]);
        const arrowLen = 15;
        const arrowX = end[0] - arrowLen * Math.cos(angle - Math.PI/6);
        const arrowY = end[1] - arrowLen * Math.sin(angle - Math.PI/6);

        ctx.beginPath();
        ctx.moveTo(end[0], end[1]);
        ctx.lineTo(arrowX, arrowY);
        ctx.strokeStyle = '#ff9800';
        ctx.lineWidth = 2.5;
        ctx.stroke();
      }
    }

    function showStatus(message, isSuccess = false) {
      statusEl.textContent = message;
      statusEl.style.background = isSuccess ? '#e8f5e9' : '#e3f2fd';
      statusEl.style.color = isSuccess ? '#2e7d32' : '#1565c0';
    }

    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
    function normalizePoint(point) {
      return [
        parseFloat((point.x / canvas.width).toFixed(3)),
        parseFloat((point.y / canvas.height).toFixed(3))
      ];
    }

    // ======================
    // 4. –†–ï–ñ–ò–ú –û–ë–£–ß–ï–ù–ò–Ø
    // ======================
    function renderLearnMode() {
      clearCanvas();

      if (!state.currentLetter) return;

      const letter = state.currentLetter;
      const currentPairIndex = state.currentStep;

      // –†–∏—Å—É–µ–º –≤—Å–µ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –ª–∏–Ω–∏–∏
      letter.points.forEach((pair, idx) => {
        if (idx < currentPairIndex) {
          drawLine(pair[0], pair[1], true);
        }
      });

      // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â—É—é –ø–∞—Ä—É —Ç–æ—á–µ–∫
      if (currentPairIndex < letter.points.length) {
        const [start, end] = letter.points[currentPairIndex];
        drawPoint(start[0], start[1], true); // –ê–∫—Ç–∏–≤–Ω–∞—è —Ç–æ—á–∫–∞
        drawPoint(end[0], end[1]);
        drawLine(start, end);
      }

      // –†–∏—Å—É–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Ç–æ—á–∫–∏
      letter.points.forEach((pair, idx) => {
        if (idx > currentPairIndex) {
          drawPoint(pair[0][0], pair[0][1]);
          drawPoint(pair[1][0], pair[1][1]);
        }
      });

      // –°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ
      if (state.currentStep >= letter.points.length) {
        showStatus(`üéâ –£—Ä–∞! –¢—ã –Ω–∞—Ä–∏—Å–æ–≤–∞–ª(–∞) –±—É–∫–≤—É "${letter.title}"! –í—ã–±–µ—Ä–∏ —Å–ª–µ–¥—É—é—â—É—é.`, true);
        // –≠—Ñ—Ñ–µ–∫—Ç –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–¥–µ—Å—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      } else {
        showStatus(`üëâ –ü—Ä–æ–≤–µ–¥–∏ –ª–∏–Ω–∏—é –æ—Ç –∫—Ä–∞—Å–Ω–æ–π —Ç–æ—á–∫–∏ –∫ —Å–µ—Ä–æ–π!`);
      }
    }

    function startLetter(letterKey) {
      state.currentLetter = { ...SAMPLE_LETTERS[letterKey], title: letterKey };
      state.currentStep = 0;
      document.querySelectorAll('.letter-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[data-letter="${letterKey}"]`).classList.add('active');
      renderLearnMode();
    }

    function handleCanvasClickLearn(x, y) {
      if (!state.currentLetter || state.currentStep >= state.currentLetter.points.length) return;

      const [start, end] = state.currentLetter.points[state.currentStep];

      // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –ø–æ–ø–∞–ª –ª–∏ –≤ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É (—Å –¥–æ–ø—É—Å–∫–æ–º)
      const distance = Math.hypot(x - end[0], y - end[1]);
      if (distance < 30) { // 30px –¥–æ–ø—É—Å–∫ –¥–ª—è –¥–µ—Ç–µ–π
        state.currentStep++;
        renderLearnMode();

        // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ —É—Å–ø–µ—Ö–µ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
        if (navigator.vibrate) navigator.vibrate(50);
      }
    }

    // ======================
    // 5. –†–ï–ñ–ò–ú –°–û–ó–î–ê–ù–ò–Ø
    // ======================
    function renderCreateMode() {
      clearCanvas();

      // –†–∏—Å—É–µ–º –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —à—Ç—Ä–∏—Ö–∏
      state.strokes.forEach(stroke => {
        if (stroke.length < 2) return;
        ctx.beginPath();
        ctx.moveTo(stroke[0].x, stroke[0].y);
        for (let i = 1; i < stroke.length; i++) {
          ctx.lineTo(stroke[i].x, stroke[i].y);
        }
        ctx.strokeStyle = '#e91e63';
        ctx.lineWidth = 4;
        ctx.lineCap = 'round';
        ctx.stroke();
      });

      // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–∏–π —à—Ç—Ä–∏—Ö
      if (state.currentStroke.length > 1) {
        ctx.beginPath();
        ctx.moveTo(state.currentStroke[0].x, state.currentStroke[0].y);
        for (let i = 1; i < state.currentStroke.length; i++) {
          ctx.lineTo(state.currentStroke[i].x, state.currentStroke[i].y);
        }
        ctx.strokeStyle = '#2196f3';
        ctx.lineWidth = 5;
        ctx.lineCap = 'round';
        ctx.stroke();
      }

      showStatus('üé® –†–∏—Å—É–π! –°–¥–µ–ª–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ —à—Ç—Ä–∏—Ö–æ–≤. –ù–∞–∂–º–∏ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å", –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—à—å.');
    }

    function startDrawing(x, y) {
      state.isDrawing = true;
      state.currentStroke = [{x, y}];
    }

    function continueDrawing(x, y) {
      if (!state.isDrawing) return;
      state.currentStroke.push({x, y});
      renderCreateMode();
    }

    function stopDrawing() {
      if (state.isDrawing && state.currentStroke.length > 1) {
        state.strokes.push([...state.currentStroke]);
      }
      state.currentStroke = [];
      state.isDrawing = false;
    }

    function applyDrawing() {
      if (state.strokes.length === 0) {
        alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Ä–∏—Å—É–π —Ñ–∏–≥—É—Ä—É!');
        return;
      }

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç {title, points}
      const figureData = {
        title: prompt('–ö–∞–∫ –Ω–∞–∑–≤–∞—Ç—å —Ñ–∏–≥—É—Ä—É? (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ó–≤–µ–∑–¥–∞", "–î–æ–º")', '–ú–æ—è–§–∏–≥—É—Ä–∞') || '–§–∏–≥—É—Ä–∞',
        points: state.strokes.map(stroke =>
          stroke.map(point => [point.x, point.y])
        )
      };

      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      const normalizedData = {
        title: figureData.title,
        points: figureData.points.map(stroke =>
          stroke.map(([x, y]) => [x / canvas.width, y / canvas.height])
        )
      };

      console.log('üé® –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–∏–≥—É—Ä–∞ (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è):');
      console.log(JSON.stringify(normalizedData, null, 2));
      console.log('üí° –°–æ–≤–µ—Ç: –°–∫–æ–ø–∏—Ä—É–π —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –∏ –¥–æ–±–∞–≤—å –≤ SAMPLE_LETTERS!');

      // –°–±—Ä–æ—Å
      state.strokes = [];
      state.currentStroke = [];
      renderCreateMode();
      showStatus('‚úÖ –§–∏–≥—É—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –∫–æ–Ω—Å–æ–ª—å! (–û—Ç–∫—Ä–æ–π DevTools ‚Üí Console)', true);

      // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
      statusEl.style.animation = 'pulse 0.5s';
      setTimeout(() => { statusEl.style.animation = ''; }, 500);
    }

    // ======================
    // 6. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô
    // ======================
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤
    document.querySelectorAll('[data-mode]').forEach(btn => {
      btn.addEventListener('click', () => {
        state.mode = btn.dataset.mode;
        createPanel.style.display = state.mode === 'create' ? 'block' : 'none';

        // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
        state.currentLetter = null;
        state.currentStep = 0;
        if (state.mode === 'create') {
          state.strokes = [];
          state.currentStroke = [];
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        document.querySelectorAll('.mode-btn').forEach(b => b.style.opacity = '0.7');
        btn.style.opacity = '1';
        render();
      });
    });

    // –í—ã–±–æ—Ä –±—É–∫–≤—ã
    Object.keys(SAMPLE_LETTERS).forEach(letter => {
      const btn = document.createElement('button');
      btn.className = 'letter-btn';
      btn.textContent = letter;
      btn.dataset.letter = letter;
      btn.addEventListener('click', () => startLetter(letter));
      lettersGrid.appendChild(btn);
    });

    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–≥—É—Ä—É
    applyBtn.addEventListener('click', applyDrawing);

    // –°–æ–±—ã—Ç–∏—è –∫–∞–Ω–≤–∞—Å–∞ (–º—ã—à—å + —Ç–∞—á)
    function getCanvasCoords(e) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;

      return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
      };
    }

    function getTouchCoords(e) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;

      return {
        x: (e.touches[0].clientX - rect.left) * scaleX,
        y: (e.touches[0].clientY - rect.top) * scaleY
      };
    }

    // Mouse events
    canvas.addEventListener('mousedown', (e) => {
      const {x, y} = getCanvasCoords(e);
      if (state.mode === 'learn') {
        handleCanvasClickLearn(x, y);
      } else {
        startDrawing(x, y);
      }
    });

    canvas.addEventListener('mousemove', (e) => {
      if (state.mode === 'create' && state.isDrawing) {
        const {x, y} = getCanvasCoords(e);
        continueDrawing(x, y);
      }
    });

    canvas.addEventListener('mouseup', () => {
      if (state.mode === 'create') stopDrawing();
    });

    canvas.addEventListener('mouseleave', () => {
      if (state.mode === 'create') stopDrawing();
    });

    // Touch events
    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const {x, y} = getTouchCoords(e);
      if (state.mode === 'learn') {
        handleCanvasClickLearn(x, y);
      } else {
        startDrawing(x, y);
      }
    });

    canvas.addEventListener('touchmove', (e) => {
      if (state.mode === 'create' && state.isDrawing) {
        e.preventDefault();
        const {x, y} = getTouchCoords(e);
        continueDrawing(x, y);
      }
    });

    canvas.addEventListener('touchend', () => {
      if (state.mode === 'create') stopDrawing();
    });

    // ======================
    // 7. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –†–ï–ù–î–ï–†
    // ======================
    function render() {
      if (state.mode === 'learn') {
        renderLearnMode();
      } else {
        renderCreateMode();
      }
    }

    // –ó–∞–ø—É—Å–∫
    function init() {
      // –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–∞ —Ä–µ—Ç–∏–Ω–∞-–¥–∏—Å–ø–ª–µ—è—Ö
      canvas.width = canvas.offsetWidth * CANVAS_SCALE;
      canvas.height = canvas.offsetHeight * CANVAS_SCALE;
      ctx.scale(CANVAS_SCALE, CANVAS_SCALE);

      // –°—Ç–∞—Ä—Ç –≤ —Ä–µ–∂–∏–º–µ –æ–±—É—á–µ–Ω–∏—è
      document.querySelector('[data-mode="learn"]').click();
      render();

      // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      setTimeout(() => {
        showStatus('üëã –ü—Ä–∏–≤–µ—Ç! –í—ã–±–µ—Ä–∏ –±—É–∫–≤—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —É—á–∏—Ç—å—Å—è —Ä–∏—Å–æ–≤–∞—Ç—å!', false);
      }, 500);
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', init);
    window.addEventListener('resize', () => {
      // –ü—Ä–∏ —Ä–µ—Å–∞–π–∑–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
      render();
    });
  </script>
</body>
</html>
